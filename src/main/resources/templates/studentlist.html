<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-header :: common_head"></head>
<body class="theme-light has-sidebar">

  <!-- Left sidebar -->
  <div th:replace="fragments/sidebar :: app_sidebar(active='students')"></div>

  <!-- Content wrapper -->
  <div class="app-main-wrap">
    <div class="container-xl py-3 max-width-100">

      <!-- Header -->
      <div class="hero-card mb-4 p-4">
        <div class="hero-content">
          <div>
            <div class="eyebrow mb-0">Students</div>
            <h2 class="hero-title">Student Directory</h2>
            <div class="hero-subtitle mt-0">Search, filter, and review admissions at a glance.</div>
          </div>
          <div class="hero-actions">
            <button class="btn btn-outline-light btn-sm" type="button" id="filterToggle">
              <i class="bi bi-funnel me-1"></i> Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Search / Controls -->
      <form class="filter-card mb-3" id="mainSearchForm"
            method="get" th:action="@{/studentlist}">
        <div class="row g-3 align-items-end">
          <div class="col-lg-6">
            <label class="form-label">Search</label>
            <div class="search-pill">
              <i class="bi bi-search"></i>
              <input type="text"
                     class="form-control border-0 bg-transparent"
                     name="q"
                     placeholder="ABS ID, student name, mobile, email"
                     th:value="${q}">
            </div>
          </div>

          <div class="col-lg-3">
            <label class="form-label">Per page</label>
            <select class="form-select soft-select" name="size" id="paginationSize" th:value="${size}">
              <option th:selected="${size== 10}" th:value="10">10</option>
              <option th:selected="${size== 25}" th:value="25">25</option>
              <option th:selected="${size== 50}" th:value="50">50</option>
            </select>
          </div>

          <div class="col-lg-2 d-grid">
            <button class="btn btn-primary-theme" type="button" onclick="applyStudentFilters()">
              <i class="bi bi-funnel me-1"></i> Apply
            </button>
          </div>
        </div>
      </form>

      <!-- Filter Panel -->
      <div class="filter-panel" id="filterPanel">
        <div class="filter-card mb-3">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="filter-title">Refine results</div>
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="applyStudentFilters()">
              <i class="bi bi-check2-circle me-1"></i> Apply
            </button>
          </div>
          <form id="filterForm">
            <div class="row g-3">

              <!-- College -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="collegeId">
                    <option value="">All Colleges</option>
                    <option th:each="c : ${colleges}"
                            th:value="${c.collegeId}"
                            th:text="${c.name}"
                            th:selected="${collegeId != null and c.collegeId != null and c.collegeId.toString() == collegeId}">
                    </option>
                  </select>
                  <label>College</label>
                </div>
              </div>

              <!-- Course -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="courseId">
                    <option value="">All Courses</option>
                    <option th:each="c : ${courses}"
                            th:value="${c.courseId}"
                            th:text="${c.name}"
                            th:selected="${courseId != null and c.courseId != null and c.courseId.toString() == courseId}">
                    </option>
                  </select>
                  <label>Course</label>
                </div>
              </div>

              <!-- Batch -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="batch">
                    <option value="">All Batches</option>
                    <option th:each="b : ${batches}"
                            th:value="${b.code}"
                            th:text="${b.label != null ? b.label : b.code}"
                            th:selected="${batch != null and b.code != null and b.code == batch}">
                    </option>
                  </select>
                  <label>Batch</label>
                </div>
              </div>

              <!-- Admission Year -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="admissionYearId">
                    <option value="">All Admission Years</option>
                    <option th:each="y : ${academicYears}"
                            th:value="${y.yearId}"
                            th:text="${y.label}"
                            th:selected="${admissionYearId != null and y.yearId != null and y.yearId.toString() == admissionYearId}">
                    </option>
                  </select>
                  <label>Admission Year</label>
                </div>
              </div>

              <!-- Gender -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="gender">
                    <option value="">All Genders</option>
                    <option value="MALE" th:selected="${gender != null and gender == 'MALE'}">Male</option>
                    <option value="FEMALE" th:selected="${gender != null and gender == 'FEMALE'}">Female</option>
                  </select>
                  <label>Gender</label>
                </div>
              </div>

              <!-- Perks -->
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="perkId">
                    <option value="">All Perks</option>
                    <option th:each="p : ${perks}"
                            th:value="${p.id}"
                            th:text="${p.name}"
                            th:selected="${perkId != null and p.id != null and p.id.toString() == perkId}">
                    </option>
                  </select>
                  <label>Perks</label>
                </div>
              </div>

            </div>
          </form>
        </div>
      </div>

      <!-- Card -->
      <div class="app-card p-0">
        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 modern-table">
            <thead class="table-light">
              <tr>
                <th class="table_header_theme" style="width:70px;">#</th>
                <th class="table_header_theme">Student</th>
                <th class="table_header_theme" style="width:220px;">College / Course</th>
                <th class="table_header_theme" style="width:160px;">Batch / Reg. No.</th>
                <th class="table_header_theme" style="width:160px;">Fee paid/pending</th>
                <th class="table_header_theme" style="width:160px;">Gender / Age</th>
                <th class="table_header_theme" style="width:160px;">Mobile</th>
                
                <th class="table_header_theme" style="width:120px;">Actions</th>
              </tr>
            </thead>

            <tbody th:if="${page != null}">
              <tr th:each="s, iStat : ${page.content}">
                <!-- Sr No based on page + index -->
                <td th:text="${page.number * page.size + iStat.index + 1}">1</td>

                <!-- Student -->
                <td>
                  <div class="fw-semibold" th:text="${s.fullName}">Student Name</div>
                  <div class="text-muted small">
                    <span th:text="${s.absId != null ? s.absId : '-'}">ABS-000000</span>
                  </div>
                </td>

                <!-- College / Course -->
                <td th:with="adm=${admissionByStudentId != null ? admissionByStudentId[s.studentId] : null}">
                  <div class="fw-semibold"
                       th:text="${adm != null and adm.college != null ? adm.college.name : '-'}">College</div>
                  <div class="text-muted small"
                       th:text="${adm != null and adm.course != null ? adm.course.name : (s.courseName != null ? s.courseName : '-')}">
                    Course
                  </div>
                </td>

                <!-- Batch + Registration -->
                <td th:with="adm=${admissionByStudentId != null ? admissionByStudentId[s.studentId] : null}">
                  <div th:text="${s.batch != null ? s.batch : (adm != null ? adm.batch : '-')}">Batch</div>
                  <div class="text-muted small"
                       th:text="${s.registrationNumber != null ? s.registrationNumber : (adm != null ? adm.registrationNumber : '-')}">
                    REG-001
                  </div>
                </td>

                <!-- Fees -->
                <td>
                  <div class="fw-semibold"
                       th:text="${paidFeesByStudentId != null and paidFeesByStudentId[s.studentId] != null ? paidFeesByStudentId[s.studentId] : 0}">
                    0
                  </div>
                  <div class="text-muted small"
                       th:text="${pendingFeesByStudentId != null and pendingFeesByStudentId[s.studentId] != null ? 'Pending ' + pendingFeesByStudentId[s.studentId] : 'Pending 0'}">
                    Pending 0
                  </div>
                </td>

                <!-- Gender + Age -->
                <td>
                  <div th:text="${s.gender != null ? s.gender : '-'}">Gender</div>
                  <div class="text-muted small"
                       th:text="${s.dob != null ? 'Age ' + T(java.time.Period).between(s.dob, T(java.time.LocalDate).now()).years : (s.age != null ? 'Age ' + s.age : '')}">
                    Age
                  </div>
                </td>

                <!-- Mobile -->
                <td th:text="${s.mobile != null ? s.mobile : '-'}">+91 98xxx xxxxx</td>

                <!-- Email 
                <td th:text="${s.email != null ? s.email : '-'}">student@example.com</td>-->

                <!-- Actions -->
                <td>
                  <div class="btn-group btn-group-sm">
                    <!-- TODO: wire student details page when ready -->
                    <a th:href="@{|/students?id=${s.studentId}|}"
                       class="btn btn-outline-secondary"
                       title="View">
                      <i class="bi bi-eye"></i>
                    </a>
                  </div>
                </td>
              </tr>

              <!-- Empty state -->
              <tr th:if="${#lists.isEmpty(page.content)}">
                <td colspan="8" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                  No students found for the applied filters.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex align-items-center justify-content-between p-3 border-top"
             th:if="${page != null}">
          <div class="text-muted small">
            <span th:text="${page.totalElements == 0 ? 0 : page.number * page.size + 1}"></span>
            –
            <span th:text="${page.number * page.size + page.numberOfElements}"></span>
            of
            <span th:text="${page.totalElements}">0</span>
          </div>
          <nav aria-label="Students pagination">
            <ul class="pagination mb-0">
              <!-- Prev -->
              <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/studentlist(q=${q}, size=${size}, page=${page.number - 1})}"
                   aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>

              <!-- Page numbers -->
              <li class="page-item"
                  th:each="p : ${#numbers.sequence(0, page.totalPages - 1)}"
                  th:classappend="${p} == ${page.number} ? 'active'">
                <a class="page-link"
                   th:text="${p + 1}"
                   th:href="@{/studentlist(q=${q}, size=${size}, page=${p})}">1</a>
              </li>

              <!-- Next -->
              <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/studentlist(q=${q}, size=${size}, page=${page.number + 1})}"
                   aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>

    </div>
  </div>
  <!-- Icons + Bootstrap JS (if not already in common_head) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Optional: sidebar drawer helper (same as your admission page if needed) -->
  <div id="sbOverlay" class="sb-overlay" hidden></div>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;900&display=swap');
    :root {
      --sbw: 260px;
      --primary: #3b3070;
      --primary-light: #7a6cb0;
      --primary-soft: #f3f1fb;
      --success: #10b981;
      --success-light: #d1fae5;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --ink: #0f172a;
      --muted: #64748b;
      --surface: #ffffff;
      --soft: #f8fafc;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    @media (max-width: 991.98px) {
      :root { --sbw: 0px; }
    }

    body.has-sidebar .app-main-wrap {
      margin-left: var(--sbw);
      transition: margin-left .2s ease;
      background: #fafbfc;
    }

    .app-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 25%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 75%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes orbitFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0.6; }
      25% { transform: translate(30px, -30px) rotate(90deg); opacity: 0.8; }
      50% { transform: translate(0, -50px) rotate(180deg); opacity: 0.7; }
      75% { transform: translate(-30px, -30px) rotate(270deg); opacity: 0.9; }
    }

    @keyframes orbitFloatReverse {
      0%, 100% { transform: translate(0, 0) rotate(360deg); opacity: 0.5; }
      25% { transform: translate(-40px, 40px) rotate(270deg); opacity: 0.7; }
      50% { transform: translate(0, 60px) rotate(180deg); opacity: 0.6; }
      75% { transform: translate(40px, 40px) rotate(90deg); opacity: 0.8; }
    }

    @keyframes pulseGlow {
      0%, 100% {
        box-shadow:
          var(--shadow-xl),
          0 0 0 1px rgba(255,255,255,0.1) inset,
          0 0 50px rgba(122, 108, 176, 0.4),
          0 0 90px rgba(122, 108, 176, 0.2);
      }
      50% {
        box-shadow:
          var(--shadow-xl),
          0 0 0 1px rgba(255,255,255,0.2) inset,
          0 0 70px rgba(122, 108, 176, 0.6),
          0 0 130px rgba(122, 108, 176, 0.3);
      }
    }

    @keyframes shimmerLine {
      0% { opacity: 0.4; transform: scaleX(0.8); }
      50% { opacity: 1; transform: scaleX(1.2); }
      100% { opacity: 0.4; transform: scaleX(0.8); }
    }

    .hero-card {
      background: linear-gradient(135deg, #3b3070 0%, #7a6cb0 100%);
      background-size: 400% 400%, 100% 100%;
      color: #ffffff;
      border-radius: var(--radius-xl);
      padding: 20px;
      position: relative;
      overflow: hidden;
      animation: gradientFlow 15s ease-in-out infinite, pulseGlow 6s ease-in-out infinite;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: var(--shadow-xl), 0 0 0 1px rgba(255,255,255,0.1) inset;
    }
    .hero-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #221b44 0%, #7a6cb0 100%);
      pointer-events: none;
      z-index: 1;
    }
    .hero-card::after {
      content: "";
      position: absolute;
      width: 600px;
      height: 600px;
      top: -200px;
      right: -200px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 30%, transparent 70%);
      border-radius: 50%;
      animation: orbitFloat 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    .hero-content::before {
      content: "";
      position: absolute;
      width: 500px;
      height: 500px;
      bottom: -250px;
      left: -150px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.12) 35%, transparent 65%);
      border-radius: 50%;
      animation: orbitFloatReverse 25s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    .hero-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.65rem;
      font-weight: 800;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 4px 0;
    }
    .eyebrow::before {
      content: "";
      width: 32px;
      height: 3px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.4));
      border-radius: 2px;
      animation: shimmerLine 2.5s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      transform-origin: left;
    }
    .eyebrow::after {
      content: "●";
      font-size: 0.5rem;
      color: rgba(255, 255, 255, 0.7);
      animation: shimmerLine 2.5s ease-in-out infinite reverse;
    }
    .hero-title {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      font-weight: 900;
      font-size: 2rem;
      margin: 0;
      position: relative;
      z-index: 1;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.9) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: white;
      background-clip: text;
      text-shadow: 0 2px 20px rgba(255, 255, 255, 0.27), 0 0 40px rgba(255, 255, 255, 0.14);
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
    }
    .hero-subtitle {
      color: rgba(255, 255, 255, 0.92);
      font-size: 0.98rem;
      position: relative;
      z-index: 1;
      margin-top: 8px;
      font-weight: 500;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      line-height: 1.6;
    }
    .hero-actions {
      position: relative;
      z-index: 2;
    }
    .hero-actions .btn {
      border: 2px solid rgba(255,255,255,0.3);
      font-weight: 600;
      padding: 8px 16px;
      transition: all 0.2s ease;
    }
    .hero-actions .btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }

    .filter-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px 22px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }
    .filter-card:hover { box-shadow: var(--shadow-lg); }
    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 8px;
      letter-spacing: 0.01em;
    }
    .search-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      transition: all 0.2s ease;
    }
    .search-pill:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
    }
    .search-pill .bi { color: var(--muted); font-size: 1.1rem; }
    .search-pill input:focus { box-shadow: none; outline: none; }
    .soft-select {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      color: var(--ink);
      font-weight: 500;
    }
    .soft-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
      outline: none;
    }

    .filter-panel {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height .35s ease, opacity .2s ease;
    }
    .filter-panel.is-open {
      max-height: 1200px;
      opacity: 1;
    }
    .filter-title { font-weight: 600; color: var(--ink); }

    .table-responsive { overflow-x: visible !important; }
    .modern-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      table-layout: fixed;
    }
    .modern-table thead th {
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      background: var(--soft);
      font-weight: 700;
      padding: 14px 12px;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .modern-table thead th:first-child { border-top-left-radius: var(--radius-md); width: 70px; }
    .modern-table thead th:nth-child(2) { width: 220px; }
    .modern-table thead th:nth-child(3) { width: 220px; }
    .modern-table thead th:nth-child(4) { width: 180px; }
    .modern-table thead th:nth-child(5) { width: 160px; }
    .modern-table thead th:nth-child(6) { width: 140px; }
    .modern-table thead th:nth-child(7) { width: 140px; }
    .modern-table thead th:last-child { border-top-right-radius: var(--radius-md); width: 90px; }
    .modern-table tbody td {
      border-bottom: 1px solid var(--border);
      color: var(--ink);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .modern-table tbody td:nth-child(2),
    .modern-table tbody td:nth-child(3) {
      white-space: normal;
      word-wrap: break-word;
    }
    .modern-table tbody tr { transition: all 0.2s ease; }
    .modern-table tbody tr:hover { background: var(--primary-soft); }
    .modern-table tbody tr:last-child td { border-bottom: none; }
    .modern-table tbody tr:last-child td:first-child { border-bottom-left-radius: var(--radius-md); }
    .modern-table tbody tr:last-child td:last-child { border-bottom-right-radius: var(--radius-md); }

    .btn-group-sm .btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .btn-group-sm .btn:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    .btn-group-sm .btn i { font-size: 1rem; }

    .pagination { gap: 6px; }
    .page-item .page-link {
      border-radius: 8px;
      border: 2px solid var(--border);
      color: var(--ink);
      font-weight: 600;
      padding: 8px 14px;
      transition: all 0.2s ease;
      margin: 0;
    }
    .page-item .page-link:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }
    .page-item.active .page-link {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-color: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    .page-item.disabled .page-link {
      background: var(--soft);
      border-color: var(--border);
      color: var(--muted);
      opacity: 0.5;
    }

    @media (max-width: 1200px) {
      .modern-table { table-layout: auto; }
      .modern-table thead th,
      .modern-table tbody td { white-space: nowrap; }
      .table-responsive { overflow-x: auto !important; }
    }
    @media (max-width: 768px) {
      .hero-card { padding: 20px 24px; border-radius: var(--radius-lg); }
      .hero-title { font-size: 1.5rem; }
      .eyebrow { font-size: 0.6rem; letter-spacing: 0.25em; }
      .eyebrow::before { width: 24px; }
      .filter-card { padding: 16px 18px; }
      .modern-table { font-size: 0.85rem; }
      .modern-table thead th,
      .modern-table tbody td { padding: 10px 8px; }
    }
    @media (max-width: 576px) {
      .hero-title { font-size: 1.45rem; }
      .hero-subtitle { font-size: 0.9rem; }
      .modern-table thead th,
      .modern-table tbody td { padding: 8px 6px; font-size: 0.8rem; }
    }
  </style>
  <script>
    (function () {
      const panel = document.getElementById("filterPanel");
      const toggle = document.getElementById("filterToggle");
      if (!panel || !toggle) return;
      toggle.addEventListener("click", function (event) {
        event.preventDefault();
        panel.classList.toggle("is-open");
        toggle.setAttribute("aria-expanded", panel.classList.contains("is-open") ? "true" : "false");
      });
    })();

    // Current filter state
    let currentFilters = {
      page: 0,
      size: 10,
      q: "",
      collegeId: "",
      courseId: "",
      batch: "",
      admissionYearId: "",
      gender: "",
      perkId: ""
    };

    // Apply Filters Function
    function applyStudentFilters() {
      const collegeId = document.getElementById("collegeId")?.value || "";
      const courseId = document.getElementById("courseId")?.value || "";
      const batch = document.getElementById("batch")?.value || "";
      const admissionYearId = document.getElementById("admissionYearId")?.value || "";
      const gender = document.getElementById("gender")?.value || "";
      const perkId = document.getElementById("perkId")?.value || "";

      // Get current search query and size from the main form
      const searchForm = document.getElementById('mainSearchForm');
      const q = searchForm?.querySelector('input[name="q"]')?.value || "";
      const size = searchForm?.querySelector('select[name="size"]')?.value || "10";

      // Update filter state
      currentFilters = {
        page: 0,
        size: parseInt(size),
        q,
        collegeId,
        courseId,
        batch,
        admissionYearId,
        gender,
        perkId
      };

      // Fetch filtered data
      fetchStudentList();
      return false; // Prevent form submission
    }

    // Fetch student list via API
    function fetchStudentList() {
      // Build URL with all filter parameters
      const params = new URLSearchParams();
      params.set("page", currentFilters.page);
      params.set("size", currentFilters.size);
      if (currentFilters.q) params.set("q", currentFilters.q);
      if (currentFilters.collegeId) params.set("collegeId", currentFilters.collegeId);
      if (currentFilters.courseId) params.set("courseId", currentFilters.courseId);
      if (currentFilters.batch) params.set("batch", currentFilters.batch);
      if (currentFilters.admissionYearId) params.set("admissionYearId", currentFilters.admissionYearId);
      if (currentFilters.gender) params.set("gender", currentFilters.gender);
      if (currentFilters.perkId) params.set("perkId", currentFilters.perkId);

      // Show loading state
      const tbody = document.querySelector('.modern-table tbody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
      }

      // Fetch data from API
      fetch("/api/studentlist?" + params.toString())
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          updateTable(data);
          updatePagination(data.page);
        })
        .catch(error => {
          console.error('Error fetching student list:', error);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-danger"><i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>Error loading data. Please try again.</td></tr>';
          }
        });
    }

    // Update table with new data
    function updateTable(data) {
      const tbody = document.querySelector('.modern-table tbody');
      if (!tbody) return;

      const students = data.page?.content || [];
      const admissionMap = data.admissionByStudentId || {};
      const paidFeesMap = data.paidFeesByStudentId || {};
      const pendingFeesMap = data.pendingFeesByStudentId || {};

      if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-4 d-block mb-2"></i>No students found for the applied filters.</td></tr>';
        return;
      }

      let html = '';
      students.forEach((student, index) => {
        const srNo = data.page.number * data.page.size + index + 1;
        const admission = admissionMap[student.studentId];
        const paidFees = paidFeesMap[student.studentId] || 0;
        const pendingFees = pendingFeesMap[student.studentId] || 0;

        html += `
          <tr>
            <td>${srNo}</td>
            <td>
              <div class="fw-semibold">${student.fullName || '-'}</div>
              <div class="text-muted small">${student.absId || '-'}</div>
            </td>
            <td>
              <div class="fw-semibold">${admission?.college?.name || '-'}</div>
              <div class="text-muted small">${admission?.course?.name || '-'}</div>
            </td>
            <td>
              <div class="fw-semibold">${student.batch || '-'}</div>
              <div class="text-muted small">${student.registrationNumber || '-'}</div>
            </td>
            <td>
              <div class="text-success fw-semibold">₹${paidFees.toLocaleString()}</div>
              <div class="text-danger small">₹${pendingFees.toLocaleString()}</div>
            </td>
            <td>
              <div class="fw-semibold">${student.gender || '-'}</div>
              <div class="text-muted small">${student.age || '-'} years</div>
            </td>
            <td>${student.mobile || '-'}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="/students?id=${student.studentId}" class="btn btn-outline-secondary" title="View">
                  <i class="bi bi-eye"></i>
                </a>
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // Update pagination
    function updatePagination(pageData) {
      if (!pageData) return;

      const paginationContainer = document.querySelector('.pagination');
      if (!paginationContainer) return;

      const totalPages = pageData.totalPages || 1;
      const currentPage = pageData.number || 0;
      const totalElements = pageData.totalElements || 0;
      const numberOfElements = pageData.numberOfElements || 0;
      const startElement = totalElements === 0 ? 0 : currentPage * pageData.size + 1;
      const endElement = currentPage * pageData.size + numberOfElements;

      // Update count display
      const countDisplay = document.querySelector('.text-muted.small');
      if (countDisplay) {
        countDisplay.innerHTML = `${startElement} – ${endElement} of ${totalElements}`;
      }

      // Build pagination HTML
      let paginationHtml = '';

      // Previous button
      paginationHtml += `
        <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      `;

      // Page numbers
      for (let i = 0; i < totalPages; i++) {
        paginationHtml += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i + 1}</a>
          </li>
        `;
      }

      // Next button
      paginationHtml += `
        <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      `;

      paginationContainer.innerHTML = paginationHtml;
    }

    // Go to specific page
    function goToPage(page) {
      currentFilters.page = page;
      fetchStudentList();
    }

    // Handle main form submission and Enter key
    document.addEventListener('DOMContentLoaded', function() {
      const mainForm = document.getElementById('mainSearchForm');
      if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
          e.preventDefault();
          applyStudentFilters();
          return false;
        });

        // Handle Enter key in search input
        const searchInput = mainForm.querySelector('input[name="q"]');
        if (searchInput) {
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              applyStudentFilters();
              return false;
            }
          });
        }
      }

      const filterForm = document.getElementById('filterForm');
      if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
          e.preventDefault();
          applyStudentFilters();
          return false;
        });
      }
    });
  </script>
  <script src="js/admission.js"></script>
</body>
</html>
