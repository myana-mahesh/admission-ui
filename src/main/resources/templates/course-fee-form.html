<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-header :: course_head">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/course.css}" />
</head>

<body>
<div class="layout">
  <div th:replace="fragments/sidebar :: app_sidebar('coursemaster')"></div>

  <!-- Sidebar (same structure as admission page) -->
  <aside class="sidebar">
    <div class="sidebar-header">ABS ERP</div>
    <nav class="sidebar-nav">
      <a th:href="@{/dashboard}" class="sidebar-link">Dashboard</a>
      <a th:href="@{/admissions}" class="sidebar-link">Admissions</a>
      <a th:href="@{/courses}" class="sidebar-link active">Courses & Fees</a>
    </nav>
  </aside>

  <!-- Main -->
  <div class="main" th:with="canEditCourses=${isSuperAdmin or #sets.contains(permissionSet,'courses:EDIT')}">
    <!-- Header -->
    <header class="header">
      <div>
        <div class="header-title">Course & Default Fee Structure</div>
        <div class="header-subtitle">Create or edit course and its default fee template</div>
      </div>
      <div class="header-right" th:text="${#dates.format(#dates.createNow(), 'dd MMM yyyy')}"></div>
    </header>

    <!-- Content -->
    <main class="content ms-1">
      <div class="card max-width-100">
        <h2 th:text="${courseForm.courseId} == null ? 'Create Course & Default Fees' : 'Edit Course & Default Fees'"></h2>
        <p class="card-subtitle">
          Define course details and split total fees into multiple installments with fixed due day/month (repeats every year).
        </p>

        <!-- IMPORTANT: matches @PostMapping("/coursessave") -->
        <form th:action="@{/coursessave}" th:object="${courseForm}" method="post"
              th:attr="data-existing-codes=${existingCourseCodes != null ? #strings.arrayJoin(existingCourseCodes, ',') : ''},
                       data-original-code=${courseForm.code != null ? courseForm.code : ''},
                       data-readonly=${!canEditCourses}">

          <!-- Hidden IDs -->
          <input type="hidden" th:field="*{courseId}" />

          <!-- Course Details -->
          <h3>Course Details</h3>
          <div class="row">
            <div class="field">
              <label>Course Code</label>
              <input type="text" th:field="*{code}" id="courseCode" placeholder="DPHARM" required />
              <div class="field-error text-danger small" id="courseCodeError"></div>
            </div>
            <div class="field">
              <label>Course Name</label>
              <input type="text" th:field="*{name}" placeholder="D.Pharm" required />
            </div>
            <div class="field">
              <label>Years</label>
              <!-- id="years" will be generated by th:field and used in JS -->
              <input type="number" th:field="*{years}" min="1" max="6" />
            </div>
          </div>

          <!-- Fee Template -->
          <h3>Default Fee Structure</h3>
          <div class="row">
            <div class="field">
              <label>Template Name</label>
              <input type="text" th:field="*{templateName}" placeholder="D.Pharm 2025 Regular Fee" required />
            </div>
            <div class="field total-box" style="max-width: 220px;">
              <label>Total (auto)</label>
              <input type="number" id="totalAmount" readonly />
            </div>
          </div>

          <!-- Installments Table -->
          <table id="installmentsTable">
            <thead>
            <tr>
              <th>#</th>
              <th>Year</th>
              <th>Sequence</th>
              <th>Amount</th>
              <th>Due Day</th>
              <th>Due Month</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="idx : ${#numbers.sequence(0, courseForm.installmentAmounts.size() - 1)}">
              <td th:text="${idx + 1}"></td>

              <!-- hidden id -->
              <input type="hidden"
                     th:name="|installmentIds[${idx}]|"
                     th:value="${courseForm.installmentIds[idx]}" />

              <!-- Year select -->
              <td>
                <select th:field="*{installmentYears[__${idx}__]}" class="form-select">
                  <option th:each="y : ${#numbers.sequence(1, courseForm.years != null && courseForm.years > 0 ? courseForm.years : 1)}"
                          th:value="${y}"
                          th:text="'Year ' + ${y}">
                  </option>
                </select>
              </td>

              <!-- Sequence -->
              <td>
                <input type="number"
                       th:name="|installmentSequences[${idx}]|"
                       th:value="${courseForm.installmentSequences[idx]}"
                       min="1" />
              </td>

              <!-- Amount -->
              <td>
                <input type="number"
                       class="amount-input"
                       th:name="|installmentAmounts[${idx}]|"
                       th:value="${courseForm.installmentAmounts[idx]}"
                       min="0" step="500" />
              </td>

              <!-- Due Day of Month -->
              <td>
                <input type="number"
                       th:name="|installmentDueDays[${idx}]|"  
                       th:value="${courseForm.installmentDueDays[idx]}"
                       min="1" max="31" step="1" />
              </td>

              <!-- Due Month -->
              <td>
				<select th:field="*{installmentDueMonths[__${idx}__]}" class="form-select">
				  <option value="1">Jan</option>
				  <option value="2">Feb</option>
				  <option value="3">Mar</option>
				  <option value="4">Apr</option>
				  <option value="5">May</option>
				  <option value="6">Jun</option>
				  <option value="7">Jul</option>
				  <option value="8">Aug</option>
				  <option value="9">Sep</option>
				  <option value="10">Oct</option>
				  <option value="11">Nov</option>
				  <option value="12">Dec</option>
				</select>
              </td>

              <td>
                <button type="button" class="btn btn-remove" onclick="removeRow(this)"
                        th:disabled="${!canEditCourses}"
                        th:classappend="${!canEditCourses} ? ' is-disabled' : ''">✕</button>
              </td>
            </tr>
            </tbody>
          </table>

          <button type="button" class="btn btn-add" onclick="addInstallmentRow()"
                  th:disabled="${!canEditCourses}"
                  th:classappend="${!canEditCourses} ? ' is-disabled' : ''">+ Add Installment</button>

          <div class="actions">
            <button type="submit" class="btn btn-primary-theme"
                    th:disabled="${!canEditCourses}"
                    th:classappend="${!canEditCourses} ? ' is-disabled' : ''">Save</button>
          </div>
        </form>
      </div>
    </main>
  </div>
</div>

<script>
  let courseFormReadOnly = false;

  function recalcTotal() {
    let total = 0;
    document.querySelectorAll('.amount-input').forEach(function (input) {
      const val = parseFloat(input.value || '0');
      if (!isNaN(val)) total += val;
    });
    const totalEl = document.getElementById('totalAmount');
    if (totalEl) totalEl.value = total;
  }

  function monthOptionsHtml(selected) {
    const months = [
      { v: 1, t: 'Jan' }, { v: 2, t: 'Feb' }, { v: 3, t: 'Mar' }, { v: 4, t: 'Apr' },
      { v: 5, t: 'May' }, { v: 6, t: 'Jun' }, { v: 7, t: 'Jul' }, { v: 8, t: 'Aug' },
      { v: 9, t: 'Sep' }, { v: 10, t: 'Oct' }, { v: 11, t: 'Nov' }, { v: 12, t: 'Dec' }
    ];
    return months.map(m => `<option value="${m.v}" ${String(selected) === String(m.v) ? 'selected' : ''}>${m.t}</option>`).join('');
  }

  function addInstallmentRow() {
    if (courseFormReadOnly) return;
    const tbody = document.getElementById('installmentsTable').querySelector('tbody');
    const rowCount = tbody.rows.length;
    const newIndex = rowCount;

    const row = tbody.insertRow(-1);

    // # column
    let cell0 = row.insertCell(0);
    cell0.textContent = rowCount + 1;

    // hidden id
    let hiddenId = document.createElement('input');
    hiddenId.type = 'hidden';
    hiddenId.name = `installmentIds[${newIndex}]`;
    hiddenId.value = '';
    row.appendChild(hiddenId);

    // Year select cell
    let cellYear = row.insertCell(1);
    const yearSelect = document.createElement('select');
    yearSelect.name = `installmentYears[${newIndex}]`;
    yearSelect.className = 'form-select';

    const yearsInput = document.getElementById('years');
    const totalYears = parseInt(yearsInput ? (yearsInput.value || '1') : '1', 10) || 1;

    for (let y = 1; y <= totalYears; y++) {
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = `Year ${y}`;
      if (y === 1) opt.selected = true;
      yearSelect.appendChild(opt);
    }
    cellYear.appendChild(yearSelect);

    // Sequence
    let cellSeq = row.insertCell(2);
    let seqInput = document.createElement('input');
    seqInput.type = 'number';
    seqInput.name = `installmentSequences[${newIndex}]`;
    seqInput.value = rowCount + 1;
    seqInput.min = '1';
    cellSeq.appendChild(seqInput);

    // Amount
    let cellAmt = row.insertCell(3);
    let amtInput = document.createElement('input');
    amtInput.type = 'number';
    amtInput.name = `installmentAmounts[${newIndex}]`;
    amtInput.value = '0';
    amtInput.min = '0';
    amtInput.step = '500';
    amtInput.classList.add('amount-input');
    amtInput.addEventListener('input', recalcTotal);
    cellAmt.appendChild(amtInput);

    // Due Day
    let cellDueDay = row.insertCell(4);
    let dueDayInput = document.createElement('input');
    dueDayInput.type = 'number';
    // IMPORTANT: keeping your existing naming "installmentDueDays[]" but it now means day-of-month
    dueDayInput.name = `installmentDueDays[${newIndex}]`;
    dueDayInput.value = '1';
    dueDayInput.min = '1';
    dueDayInput.max = '31';
    dueDayInput.step = '1';
    cellDueDay.appendChild(dueDayInput);

    // Due Month
    let cellDueMonth = row.insertCell(5);
    let dueMonthSelect = document.createElement('select');
    dueMonthSelect.className = 'form-select';
    dueMonthSelect.name = `installmentDueMonths[${newIndex}]`;
    dueMonthSelect.innerHTML = monthOptionsHtml(1);
    cellDueMonth.appendChild(dueMonthSelect);

    // Remove button
    let cellBtn = row.insertCell(6);
    let btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-remove';
    btn.textContent = '✕';
    btn.onclick = function () { removeRow(btn); };
    cellBtn.appendChild(btn);

    recalcTotal();
  }

  function removeRow(btn) {
    if (courseFormReadOnly) return;
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    tbody.removeChild(row);

    // Re-index rows and input names (including year, due day, due month)
    Array.from(tbody.rows).forEach(function (r, index) {
      r.cells[0].textContent = index + 1;

      const hiddenId = r.querySelector('input[type="hidden"][name^="installmentIds"]');
      const yearSelect = r.querySelector('select[name^="installmentYears"]');
      const seqInput = r.querySelector('input[name^="installmentSequences"]');
      const amtInput = r.querySelector('input.amount-input[name^="installmentAmounts"]');
      const dueDayInput = r.querySelector('input[name^="installmentDueDays"]');
      const dueMonthSelect = r.querySelector('select[name^="installmentDueMonths"]');

      if (hiddenId) hiddenId.name = `installmentIds[${index}]`;
      if (yearSelect) yearSelect.name = `installmentYears[${index}]`;
      if (seqInput) seqInput.name = `installmentSequences[${index}]`;
      if (amtInput) amtInput.name = `installmentAmounts[${index}]`;
      if (dueDayInput) dueDayInput.name = `installmentDueDays[${index}]`;
      if (dueMonthSelect) dueMonthSelect.name = `installmentDueMonths[${index}]`;
    });

    recalcTotal();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form[action="/coursessave"]');
    const courseCodeInput = document.getElementById('courseCode');
    const courseCodeError = document.getElementById('courseCodeError');
    courseFormReadOnly = !!(form && form.dataset.readonly === 'true');

    if (courseFormReadOnly && form) {
      form.querySelectorAll('input, select, textarea, button').forEach(function (el) {
        if (el.type === 'hidden') return;
        el.disabled = true;
        el.classList.add('is-disabled');
      });
    }

    function getExistingCodes() {
      const raw = (form && form.dataset.existingCodes) ? form.dataset.existingCodes : '';
      if (!raw.trim()) return new Set();
      return new Set(raw.split(',').map(v => v.trim().toUpperCase()).filter(Boolean));
    }

    function validateCourseCode() {
      if (!courseCodeInput || !courseCodeError) return true;
      const code = (courseCodeInput.value || '').trim().toUpperCase();
      const original = (form.dataset.originalCode || '').trim().toUpperCase();
      const existing = getExistingCodes();
      const isDuplicate = code && code !== original && existing.has(code);

      if (isDuplicate) {
        courseCodeError.textContent = 'Course code already exists. Please use a unique code.';
        courseCodeInput.classList.add('is-invalid');
        return false;
      }

      courseCodeError.textContent = '';
      courseCodeInput.classList.remove('is-invalid');
      return true;
    }

    if (courseCodeInput) {
      courseCodeInput.addEventListener('input', validateCourseCode);
      courseCodeInput.addEventListener('blur', validateCourseCode);
    }

    if (form) {
      form.addEventListener('submit', function (e) {
        if (courseFormReadOnly) {
          e.preventDefault();
          return;
        }
        if (!validateCourseCode()) {
          e.preventDefault();
          courseCodeInput && courseCodeInput.focus();
        }
      });
    }

    document.querySelectorAll('.amount-input').forEach(function (input) {
      input.addEventListener('input', recalcTotal);
    });
    recalcTotal();
  });
</script>
</body>
</html>
