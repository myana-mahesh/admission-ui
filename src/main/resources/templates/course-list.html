<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-header :: course_head">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Page specific CSS -->
    <link rel="stylesheet" th:href="@{/css/course.css}" />
</head>
<body>
<div class="layout">

    <!-- Existing sidebar fragment (same as your form page) -->
    <div th:replace="fragments/sidebar :: app_sidebar('coursemaster')"></div>

    <!-- Extra sidebar block you are already using on the form page -->
    <aside class="sidebar">
        <div class="sidebar-header">
            ABS ERP
        </div>
        <nav class="sidebar-nav">
            <a th:href="@{/dashboard}" class="sidebar-link">Dashboard</a>
            <a th:href="@{/admissions}" class="sidebar-link">Admissions</a>
            <a th:href="@{/courses}" class="sidebar-link active">Courses & Fees</a>
        </nav>
    </aside>

    <!-- Main -->
    <div class="main" th:with="canEditCourses=${isSuperAdmin or #sets.contains(permissionSet,'courses:EDIT')}">
        <!-- Header (matching your form header) -->
        <header class="header">
            <div>
                <div class="header-title">Courses & Default Fee Templates</div>
                <div class="header-subtitle">View all courses and open details to edit fee structure</div>
            </div>
            <div class="header-right"
                 th:text="${#dates.format(#dates.createNow(), 'dd MMM yyyy')}">
            </div>
        </header>

        <!-- Content -->
        <main class="content ms-1">
            <div class="card course-list-card">

                <!-- Card header row -->
                <div class="course-card-header">
                    <div>
                        <h2 class="course-card-title">Courses</h2>
                        <p class="card-subtitle mb-0">
                            Click on any course row to open the detailed course & fee edit page.
                        </p>
                    </div>
                    <div class="course-card-actions">
                        <!-- uses your existing /coursescreate mapping -->
                        <a th:href="${canEditCourses} ? @{/coursescreate} : '#'"
                           th:classappend="${!canEditCourses} ? ' is-disabled' : ''"
                           th:attr="aria-disabled=${!canEditCourses}, tabindex=${!canEditCourses} ? -1 : 0">
                            <button type="button" class="btn btn-primary-theme" th:disabled="${!canEditCourses}">
                                + Add New Course
                            </button>
                        </a>
                    </div>
                </div>

                <!-- Search -->
                <div class="course-list-search-row">
                    <input id="courseSearch"
                           type="text"
                           class="course-list-search-input"
                           placeholder="Search by course code or course name..."
                           oninput="filterCourses()" />
                </div>
                <div id="courseDeleteAlert" class="course-alert" role="status" style="display: none;"></div>
                <div id="courseDeleteModal" class="status-modal" aria-hidden="true">
                    <div class="status-modal-card">
                        <div class="status-modal-icon" id="courseDeleteModalIcon">!</div>
                        <div class="status-modal-title" id="courseDeleteModalTitle">Status</div>
                        <div class="status-modal-message" id="courseDeleteModalMessage"></div>
                        <div class="status-modal-actions">
                            <button type="button" class="btn btn-primary-theme" id="courseDeleteModalClose">OK</button>
                        </div>
                    </div>
                </div>
                <div id="courseConfirmModal" class="status-modal" aria-hidden="true">
                    <div class="status-modal-card">
                        <div class="status-modal-icon" id="courseConfirmModalIcon">?</div>
                        <div class="status-modal-title" id="courseConfirmModalTitle">Confirm Delete</div>
                        <div class="status-modal-message" id="courseConfirmModalMessage"></div>
                        <div class="status-modal-actions">
                            <button type="button" class="btn btn-outline-secondary" id="courseConfirmCancel">Cancel</button>
                            <button type="button" class="btn btn-primary-theme" id="courseConfirmOk">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="course-table-wrapper">
                    <table id="coursesTable" class="course-table">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Code</th>
                            <th>Course Name</th>
                            <th>Years</th>
                            <th>Template Name</th>
                            <th>Total Installments</th>
                            <th>Total Amount</th>
                            <th class="course-table-action-col">Action</th>
                        </tr>
                        </thead>
						<tbody>
						<!-- courses is List<CourseFeeRequestDto> -->
						<tr th:each="c, stat : ${courses}"
						    th:onclick="${canEditCourses} ? 'window.location.href=\'' + @{/courseedit(courseId=${c.courseId})} + '\';' : null"
						    th:classappend="${!canEditCourses} ? ' course-row-disabled' : ''">
						    <td th:text="${stat.index + 1}"></td>
						    <td th:text="${c.code}"></td>
						    <td th:text="${c.name}"></td>
						    <td>
						        <span th:text="${c.years}"></span>
						        <span class="course-text-muted">years</span>
						    </td>

						    <!-- Template Name -->
						    <td th:text="${c.feeTemplate != null ? c.feeTemplate.name : '—'}"></td>

						    <!-- Total Installments (size of feeTemplate.installments) -->
						    <td>
						        <span class="course-badge-pill"
						              th:text="${c.feeTemplate != null 
						                        and c.feeTemplate.installments != null 
						                        and !#lists.isEmpty(c.feeTemplate.installments)
						                        ? #lists.size(c.feeTemplate.installments) + ' installments'
						                        : '—'}">
						        </span>
						    </td>

						    <!-- Total Amount (feeTemplate.totalAmount) -->
						    <td th:text="${c.feeTemplate != null 
						                  and c.feeTemplate.totalAmount != null
						                  ? '₹' + c.feeTemplate.totalAmount
						                  : '—'}">
						    </td>

                            <td class="course-table-action-cell"
                                onclick="event.stopPropagation();">
                                <a th:href="${canEditCourses} ? @{/courseedit(courseId=${c.courseId})} : '#'"
                                   th:classappend="${!canEditCourses} ? ' is-disabled' : ''"
                                   th:attr="aria-disabled=${!canEditCourses}, tabindex=${!canEditCourses} ? -1 : 0">
                                    <button type="button" class="btn btn-outline-theme" th:disabled="${!canEditCourses}">
                                        Edit
                                    </button>
                                </a>
                                <button type="button"
                                        class="btn btn-outline-danger course-delete-btn"
                                        th:classappend="${!canEditCourses} ? ' is-disabled' : ''"
                                        th:disabled="${!canEditCourses}"
                                        th:attr="data-course-id=${canEditCourses ? c.courseId : ''},data-course-name=${canEditCourses ? c.name : ''}"
                                        onclick="event.stopPropagation();">
                                    Delete
                                </button>
                            </td>
                        </tr>

						<!-- Empty state -->
						<tr th:if="${#lists.isEmpty(courses)}">
						    <td colspan="8" class="course-empty-row">
						        No courses configured yet. Click “Add New Course” to create one.
						    </td>
						</tr>
						</tbody>

                    </table>
                </div>

            </div>
        </main>
    </div>
</div>

<script>
    function showCourseAlert(message, isError) {
        const alert = document.getElementById('courseDeleteAlert');
        if (alert) {
            alert.textContent = message;
            alert.classList.toggle('is-error', !!isError);
            alert.classList.toggle('is-success', !isError);
            alert.style.display = 'none';
        }

        const modal = document.getElementById('courseDeleteModal');
        const modalIcon = document.getElementById('courseDeleteModalIcon');
        const modalTitle = document.getElementById('courseDeleteModalTitle');
        const modalMessage = document.getElementById('courseDeleteModalMessage');
        if (modal && modalIcon && modalTitle && modalMessage) {
            modalIcon.classList.toggle('is-success', !isError);
            modalTitle.textContent = isError ? 'Unable to delete course' : 'Course deleted';
            modalMessage.textContent = message;
            modal.classList.add('is-open');
            modal.setAttribute('aria-hidden', 'false');
        }
    }

    (function () {
        const modal = document.getElementById('courseDeleteModal');
        const closeBtn = document.getElementById('courseDeleteModalClose');
        if (!modal || !closeBtn) return;
        const close = () => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
        };
        closeBtn.addEventListener('click', close);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) close();
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') close();
        });
    })();

    function openConfirmModal(message, onConfirm) {
        const modal = document.getElementById('courseConfirmModal');
        const msg = document.getElementById('courseConfirmModalMessage');
        const okBtn = document.getElementById('courseConfirmOk');
        const cancelBtn = document.getElementById('courseConfirmCancel');
        if (!modal || !msg || !okBtn || !cancelBtn) return;
        msg.textContent = message;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');

        const close = () => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
            okBtn.removeEventListener('click', onConfirmHandler);
        };
        const onConfirmHandler = () => {
            close();
            if (typeof onConfirm === 'function') onConfirm();
        };
        okBtn.addEventListener('click', onConfirmHandler);
        cancelBtn.addEventListener('click', close, { once: true });
        modal.addEventListener('click', (event) => {
            if (event.target === modal) close();
        }, { once: true });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') close();
        }, { once: true });
    }

    function wireCourseDeleteButtons() {
        document.querySelectorAll('.course-delete-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', () => {
                const courseId = btn.getAttribute('data-course-id');
                const courseName = btn.getAttribute('data-course-name') || 'this course';
                if (!courseId) return;
                openConfirmModal(`Delete ${courseName}? This cannot be undone.`, () => {
                    fetch(`/courses/${courseId}`, { method: 'DELETE' })
                        .then(async response => {
                            if (response.ok) {
                                const row = btn.closest('tr');
                                if (row) row.remove();
                                showCourseAlert(`Deleted ${courseName} successfully.`, false);
                                return;
                            }
                            const message = await response.text();
                            const fallback = response.status === 409
                                ? 'Cannot delete this course because admissions already exist for it.'
                                : 'Unable to delete the course.';
                            showCourseAlert(message || fallback, true);
                        })
                        .catch(() => showCourseAlert('Unable to delete the course.', true));
                });
            });
        });
    }

    function filterCourses() {
        const query = (document.getElementById('courseSearch').value || '').toLowerCase();
        const rows = document.querySelectorAll('#coursesTable tbody tr');

        rows.forEach(row => {
            const cells = row.children;
            if (!cells || cells.length < 3) return;

            // skip “no courses” row
            if (row.querySelector('.course-empty-row')) {
                return;
            }

            const code = (cells[1].textContent || '').toLowerCase();
            const name = (cells[2].textContent || '').toLowerCase();

            if (!query || code.includes(query) || name.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    wireCourseDeleteButtons();
</script>
</body>
</html>
