<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-header :: common_head"></head>
<body class="theme-light has-sidebar">

<div th:replace="fragments/sidebar :: app_sidebar(active='branches')"></div>

<div class="app-main-wrap" th:with="canEditBranches=${isSuperAdmin or #sets.contains(permissionSet,'branches:EDIT')}">
    <div class="container-xl py-3 max-width-100">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="mb-0">Branch Master</h3>
                <small class="text-muted">Create, edit and delete branches.</small>
            </div>

            <div>
                <a class="btn btn-sm btn-primary-theme" href="javascript:void(0);" onclick="openCreateBranchModal()" th:if="${canEditBranches}">
                    + Add New
                </a>
            </div>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <div class="card">
            <div class="card-body p-0">
                <div id="branchDeleteModal" class="status-modal" aria-hidden="true">
                    <div class="status-modal-card">
                        <div class="status-modal-icon" id="branchDeleteModalIcon">!</div>
                        <div class="status-modal-title" id="branchDeleteModalTitle">Status</div>
                        <div class="status-modal-message" id="branchDeleteModalMessage"></div>
                        <div class="status-modal-actions">
                            <button type="button" class="btn btn-primary-theme" id="branchDeleteModalClose">OK</button>
                        </div>
                    </div>
                </div>
                <div id="branchConfirmModal" class="status-modal" aria-hidden="true">
                    <div class="status-modal-card">
                        <div class="status-modal-icon" id="branchConfirmModalIcon">?</div>
                        <div class="status-modal-title" id="branchConfirmModalTitle">Confirm Delete</div>
                        <div class="status-modal-message" id="branchConfirmModalMessage"></div>
                        <div class="status-modal-actions">
                            <button type="button" class="btn btn-outline-secondary" id="branchConfirmCancel">Cancel</button>
                            <button type="button" class="btn btn-primary-theme" id="branchConfirmOk">Delete</button>
                        </div>
                    </div>
                </div>
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th class="table_header_theme" style="width: 80px;">ID</th>
                        <th class="table_header_theme">Code</th>
                        <th class="table_header_theme">Branch Name</th>
                        <th class="table_header_theme">Address</th>
                        <th class="table_header_theme" style="width: 160px;" th:if="${canEditBranches}">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(branches)}">
                        <td th:attr="colspan=${canEditBranches} ? 5 : 4" class="text-center text-muted py-3">
                            No branches found.
                        </td>
                    </tr>
                    <tr th:each="b : ${branches}">
                        <td th:text="${b.id}">1</td>
                        <td th:text="${b.code}">ABS</td>
                        <td th:text="${b.name}">Main Branch</td>
                        <td th:text="${b.address}">Address</td>
                        <td th:if="${canEditBranches}">
                            <div class="d-flex gap-1" th:if="${canEditBranches}">
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary-theme"
                                        th:attr="data-id=${b.id},
                                                 data-code=${b.code},
                                                 data-name=${b.name},
                                                 data-address=${b.address}"
                                        onclick="openEditBranchModal(this)">
                                    Edit
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger branch-delete-btn"
                                        th:attr="data-branch-id=${b.id},
                                                 data-branch-name=${b.name}">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="branchModalTitle">Add New Branch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="branchForm" th:action="@{/branches/save}" th:object="${branch}" method="post">
                    <input type="hidden" id="branchId" th:field="*{id}"/>

                    <div class="mb-3">
                        <label class="form-label">Code</label>
                        <input type="text" id="branchCode" th:field="*{code}" class="form-control"
                               placeholder="e.g. ABS, MAIN">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Branch Name <span class="text-danger">*</span></label>
                        <input type="text" id="branchName" th:field="*{name}" class="form-control"
                               placeholder="Branch name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea id="branchAddress" th:field="*{address}" class="form-control" rows="2"
                                  placeholder="Branch address"></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary-theme" >
                            <span id="branchSubmitLabel">Save</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<style>
    .status-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.45);
        z-index: 2000;
        padding: 24px;
    }
    .status-modal.is-open {
        display: flex;
    }
    .status-modal-card {
        width: min(420px, 92vw);
        background: #fff;
        border-radius: 18px;
        padding: 22px 24px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        text-align: center;
    }
    .status-modal-icon {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 12px;
        background: #fee2e2;
        color: #b91c1c;
    }
    .status-modal-icon.is-success {
        background: #dcfce7;
        color: #166534;
    }
    .status-modal-title {
        font-size: 1.05rem;
        font-weight: 700;
        margin-bottom: 6px;
        color: #0f172a;
    }
    .status-modal-message {
        font-size: 0.92rem;
        color: #475569;
        margin-bottom: 16px;
    }
    .status-modal-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
</style>

<script th:inline="javascript">
/*<![CDATA[*/
    function getBranchModalInstance() {
        const modalEl = document.getElementById('branchModal');
        return bootstrap.Modal.getOrCreateInstance(modalEl);
    }

    function openCreateBranchModal() {
        const form = document.getElementById('branchForm');
        if (form) {
            form.reset();
        }

        const idField = document.getElementById('branchId');
        const titleEl = document.getElementById('branchModalTitle');
        const submitLabel = document.getElementById('branchSubmitLabel');

        if (idField) idField.value = '';
        if (titleEl) titleEl.textContent = 'Add New Branch';
        if (submitLabel) submitLabel.textContent = 'Save';

        getBranchModalInstance().show();
    }

    function openEditBranchModal(button) {
        const id = button.getAttribute('data-id');
        const code = button.getAttribute('data-code');
        const name = button.getAttribute('data-name');
        const address = button.getAttribute('data-address');

        const idField = document.getElementById('branchId');
        const codeField = document.getElementById('branchCode');
        const nameField = document.getElementById('branchName');
        const addressField = document.getElementById('branchAddress');
        const titleEl = document.getElementById('branchModalTitle');
        const submitLabel = document.getElementById('branchSubmitLabel');

        if (idField) idField.value = id || '';
        if (codeField) codeField.value = code || '';
        if (nameField) nameField.value = name || '';
        if (addressField) addressField.value = address || '';
        if (titleEl) titleEl.textContent = 'Edit Branch';
        if (submitLabel) submitLabel.textContent = 'Update';

        getBranchModalInstance().show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        var isEdit = /*[[${branch.id} != null]]*/ false;
        if (isEdit) {
            const titleEl = document.getElementById('branchModalTitle');
            const submitLabel = document.getElementById('branchSubmitLabel');
            if (titleEl) titleEl.textContent = 'Edit Branch';
            if (submitLabel) submitLabel.textContent = 'Update';
            getBranchModalInstance().show();
        }
    });

    function showBranchModal(message, isError) {
        const modal = document.getElementById('branchDeleteModal');
        const modalIcon = document.getElementById('branchDeleteModalIcon');
        const modalTitle = document.getElementById('branchDeleteModalTitle');
        const modalMessage = document.getElementById('branchDeleteModalMessage');
        if (!modal || !modalIcon || !modalTitle || !modalMessage) return;
        modalIcon.classList.toggle('is-success', !isError);
        modalTitle.textContent = isError ? 'Unable to delete branch' : 'Branch deleted';
        modalMessage.textContent = message;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
    }

    (function () {
        const modal = document.getElementById('branchDeleteModal');
        const closeBtn = document.getElementById('branchDeleteModalClose');
        if (!modal || !closeBtn) return;
        const close = () => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
        };
        closeBtn.addEventListener('click', close);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) close();
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') close();
        });
    })();

    function openBranchConfirmModal(message, onConfirm) {
        const modal = document.getElementById('branchConfirmModal');
        const msg = document.getElementById('branchConfirmModalMessage');
        const okBtn = document.getElementById('branchConfirmOk');
        const cancelBtn = document.getElementById('branchConfirmCancel');
        if (!modal || !msg || !okBtn || !cancelBtn) return;
        msg.textContent = message;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');

        const close = () => {
            modal.classList.remove('is-open');
            modal.setAttribute('aria-hidden', 'true');
            okBtn.removeEventListener('click', onConfirmHandler);
        };
        const onConfirmHandler = () => {
            close();
            if (typeof onConfirm === 'function') onConfirm();
        };
        okBtn.addEventListener('click', onConfirmHandler);
        cancelBtn.addEventListener('click', close, { once: true });
        modal.addEventListener('click', (event) => {
            if (event.target === modal) close();
        }, { once: true });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') close();
        }, { once: true });
    }

    function wireBranchDeleteButtons() {
        document.querySelectorAll('.branch-delete-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', () => {
                const branchId = btn.getAttribute('data-branch-id');
                const branchName = btn.getAttribute('data-branch-name') || 'this branch';
                if (!branchId) return;
                openBranchConfirmModal(`Delete ${branchName}? This cannot be undone.`, () => {
                    fetch(`/branches/${branchId}`, { method: 'DELETE' })
                        .then(async response => {
                            if (response.ok) {
                                const row = btn.closest('tr');
                                if (row) row.remove();
                                showBranchModal(`Deleted ${branchName} successfully.`, false);
                                return;
                            }
                            const message = await response.text();
                            const fallback = response.status === 409
                                ? 'Cannot delete this branch because admissions already exist for it.'
                                : 'Unable to delete the branch.';
                            showBranchModal(message || fallback, true);
                        })
                        .catch(() => showBranchModal('Unable to delete the branch.', true));
                });
            });
        });
    }

    wireBranchDeleteButtons();
/*]]>*/
</script>

</body>
</html>
